# VS Code LM Proxy Server

ã“ã®æ‹¡å¼µæ©Ÿèƒ½ã¯ã€VS Code ãŒæä¾›ã™ã‚‹ Language Model (LM) API ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ OpenAI Responses API äº’æ›ã® HTTP ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã¨ã—ã¦å…¬é–‹ã™ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã§ã™ã€‚å¤–éƒ¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯æ‹¡å¼µæ©Ÿèƒ½ãŒç«‹ã¡ä¸Šã’ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã—ã¦ OpenAI ã® `/v1/responses` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨åŒæ§˜ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã€ãã®çµæœã‚’ VS Code å†…ã§åˆ©ç”¨å¯èƒ½ãªè¨€èªãƒ¢ãƒ‡ãƒ«ã«è»¢é€ã—ã¦å¿œç­”ã‚’å–å¾—ã§ãã¾ã™ã€‚

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

1. ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€TypeScript ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚

   ```bash
   npm install
   npm run compile
   ```

2. VS Code ã§ã€ŒLaunch Extensionã€æ§‹æˆã‚’ä½¿ã£ã¦æ‹¡å¼µæ©Ÿèƒ½ã‚’èµ·å‹•ã™ã‚‹ã‹ã€`vsce package` ã§ `.vsix` ã‚’ç”Ÿæˆã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

æ‹¡å¼µæ©Ÿèƒ½ã¯èµ·å‹•æ™‚ã«è‡ªå‹•çš„ã«ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã¾ã™ã€‚åˆå›ã®ãƒ¢ãƒ‡ãƒ«å‘¼ã³å‡ºã—æ™‚ã«ã¯ VS Code ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

## ã‚µãƒ¼ãƒãƒ¼è¨­å®š

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ `127.0.0.1:3141` ã§ãƒªãƒƒã‚¹ãƒ³ã—ã¾ã™ã€‚æ¬¡ã®è¨­å®šã§å¤‰æ›´ã§ãã¾ã™ã€‚

| è¨­å®šã‚­ãƒ¼ | èª¬æ˜ |
|----------|------|
| `lmProxyServer.host` | ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ãƒ›ã‚¹ãƒˆåã¾ãŸã¯ IPã€‚ |
| `lmProxyServer.port` | åˆ©ç”¨ã™ã‚‹ãƒãƒ¼ãƒˆç•ªå·ã€‚ç’°å¢ƒå¤‰æ•° `VS_CODE_LM_PROXY_PORT` ã§ã‚‚ä¸Šæ›¸ãå¯èƒ½ã€‚ |

## ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### `GET /health`

çŠ¶æ…‹ç¢ºèªç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€‚`{"status": "ok"}` ã‚’è¿”ã—ã¾ã™ã€‚

### `POST /v1/responses`

OpenAI Responses API äº’æ›ã®ãƒœãƒ‡ã‚£ã‚’å—ã‘å–ã‚Šã€VS Code LM API ã«è»¢é€ã—ã¾ã™ã€‚ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ä¸»ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:

```jsonc
{
  "model": "model-id",          // çœç•¥æ™‚ã¯ VS Code ã§ä½¿ç”¨å¯èƒ½ãªæœ€åˆã®ãƒ¢ãƒ‡ãƒ«ãŒé¸æŠã•ã‚Œã¾ã™
  "messages": [
    {
      "role": "user",
      "content": [
        { "type": "text", "text": "ã“ã‚“ã«ã¡ã¯" }
      ]
    }
  ]
}
```

ã¾ãŸã¯ `input` ã«æ–‡å­—åˆ—ã¾ãŸã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—ã‚’æ¸¡ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚`content` ã¯ `type: text` ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚VS Code Insidersç‰ˆã§ã¯ç”»åƒå…¥åŠ›ï¼ˆ`type: image_url`ï¼‰ã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ï¼ˆè©³ç´°ã¯ã€Œãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç”»åƒï¼‰å¯¾å¿œã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ï¼‰ã€‚

å¿œç­”ã¯ OpenAI Responses API ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚’æ¨¡ã—ãŸ JSON ã‚’è¿”ã—ã¾ã™ã€‚

```json
{
  "id": "resp_1710666570000",
  "object": "response",
  "created": 1710666570,
  "model": "resolved-model-id",
  "usage": {
    "input_tokens": 0,
    "output_tokens": 0,
    "total_tokens": 0
  },
  "choices": [
    {
      "index": 0,
      "type": "message",
      "message": {
        "role": "assistant",
        "content": [
          { "type": "text", "text": "ãƒ¢ãƒ‡ãƒ«ã®å¿œç­”..." }
        ]
      },
      "finish_reason": "stop"
    }
  ]
}
```

#### ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°

ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã§ `stream: true` ã‚’æŒ‡å®šã™ã‚‹ã¨ã€`text/event-stream` ã‚’ç”¨ã„ãŸ SSE å½¢å¼ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒ é…ä¿¡ã—ã¾ã™ã€‚OpenAI Responses API ã¨åŒæ§˜ã« `response.created` ã‚„ `response.output_text.delta` ãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒé †æ¬¡é€ã‚‰ã‚Œã€æœ€å¾Œã« `[DONE]` ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚

```bash
curl -N \
  -H "Content-Type: application/json" \
  -H "Accept: text/event-stream" \
  -d '{
        "model": "gpt-5-mini",
        "stream": true,
        "messages": [
          { "role": "user", "content": [{ "type": "text", "text": "ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§å¿œç­”ã—ã¦" }] }
        ]
      }' \
  http://127.0.0.1:3141/v1/responses
```

ç¾åœ¨ã¯ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ«ã‚¿ã®ã¿ã‚’ã‚µãƒãƒ¼ãƒˆã—ã€ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã‚„ãã®ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯æœªå¯¾å¿œã§ã™ã€‚

## Google ADK äº’æ› API

ã“ã®ã‚µãƒ¼ãƒãƒ¼ã¯ Google Agent Development Kit (ADK) ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã‚‚æ¥ç¶šå¯èƒ½ã§ã™ã€‚

### `GET /list-apps`

åˆ©ç”¨å¯èƒ½ãªã‚¢ãƒ—ãƒªä¸€è¦§ã‚’è¿”ã—ã¾ã™ã€‚

```bash
curl http://127.0.0.1:3141/list-apps
# => ["vscode-lm-proxy"]
```

### `POST /run`

ADK å½¢å¼ã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆéã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰ã€‚

```bash
curl -X POST http://127.0.0.1:3141/run \
  -H "Content-Type: application/json" \
  -d '{
    "app_name": "vscode-lm-proxy",
    "user_id": "user-123",
    "session_id": "session-456",
    "new_message": {
      "parts": [{"text": "ã“ã‚“ã«ã¡ã¯"}],
      "role": "user"
    }
  }'
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ ADK Event é…åˆ—å½¢å¼:

```json
[
  {
    "id": "evt_00000001",
    "invocation_id": "inv_1234567890",
    "timestamp": 1234567890.123,
    "author": "assistant",
    "content": {
      "parts": [{"text": "ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ"}],
      "role": "model"
    }
  }
]
```

### `POST /run_sse`

ADK å½¢å¼ã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆSSE ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰ã€‚

```bash
curl -N http://127.0.0.1:3141/run_sse \
  -H "Content-Type: application/json" \
  -d '{
    "app_name": "vscode-lm-proxy",
    "user_id": "user-123",
    "session_id": "session-456",
    "new_message": {
      "parts": [{"text": "é•·ã„èª¬æ˜ã‚’ã—ã¦ãã ã•ã„"}],
      "role": "user"
    }
  }'
```

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

- `GET /apps/{app_name}/users/{user_id}/sessions` - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§
- `POST /apps/{app_name}/users/{user_id}/sessions` - æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
- `GET /apps/{app_name}/users/{user_id}/sessions/{session_id}` - ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°
- `DELETE /apps/{app_name}/users/{user_id}/sessions/{session_id}` - ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤

### ADK ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®æ¥ç¶š

ADK ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ `base_url` ã‚’ã“ã®ã‚µãƒ¼ãƒãƒ¼ã«å‘ã‘ã¦è¨­å®šã—ã¦ãã ã•ã„:

```python
# ä¾‹: ADK ã‚’ LiteLLM çµŒç”±ã§æ¥ç¶šã™ã‚‹å ´åˆ
# ã“ã®ã‚µãƒ¼ãƒãƒ¼ã‚’ http://127.0.0.1:3141 ã§èµ·å‹•ã—ãŸçŠ¶æ…‹ã§
# ADK ã®è¨­å®šã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®š
```

## ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç”»åƒï¼‰å¯¾å¿œ

**VS Code Insidersç‰ˆã§ç”»åƒå…¥åŠ›ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™**ï¼ˆProposed API: `languageModelDataPart`ï¼‰

ğŸ“š **è©³ã—ã„ä½¿ç”¨ä¾‹ã¯ [examples/](./examples/) ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‚ç…§ã—ã¦ãã ã•ã„**

### Google ADK API

ç”»åƒã‚’é€ä¿¡ã™ã‚‹ã«ã¯ã€`parts`ã«`data`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚ã¾ã™ï¼š

```jsonc
{
  "app_name": "vscode-lm-proxy",
  "user_id": "user-123",
  "session_id": "session-456",
  "new_message": {
    "parts": [
      {"text": "ã“ã®ç”»åƒã«ã¯ä½•ãŒå†™ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ"},
      {
        "data": {
          "data": "iVBORw0KGgoAAAANSUhEUgAAAAUA...", // base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿
          "mime_type": "image/png"
        }
      }
    ],
    "role": "user"
  }
}
```

### OpenAI Assistants API

ç”»åƒã‚’é€ä¿¡ã™ã‚‹ã«ã¯ã€`content`é…åˆ—ã«`image_url`ã‚¿ã‚¤ãƒ—ã‚’å«ã‚ã¾ã™ï¼š

```jsonc
{
  "role": "user",
  "content": [
    {"type": "text", "text": {"value": "ã“ã®ç”»åƒã«ã¯ä½•ãŒå†™ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ"}},
    {
      "type": "image_url",
      "image_url": {
        "url": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUA..."
      }
    }
  ]
}
```

**æ³¨æ„ï¼š**
- ç¾åœ¨ã€data URIå½¢å¼ï¼ˆ`data:image/...;base64,...`ï¼‰ã®ã¿ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™
- HTTP(S) URLã‹ã‚‰ã®ç”»åƒå–å¾—ã¯æœªå¯¾å¿œã§ã™
- `image_file`ã‚¿ã‚¤ãƒ—ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«IDï¼‰ã¯æœªå¯¾å¿œã§ã™

## æ³¨æ„äº‹é …

- **ç”»åƒå¯¾å¿œ**ï¼šVS Code Insidersç‰ˆã®Proposed APIã‚’ä½¿ç”¨ã—ã¦ç”»åƒå…¥åŠ›ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚å®‰å®šç‰ˆVS Codeã§ã¯ç”»åƒæ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚
- **ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—**ï¼šç¾åœ¨æœªå¯¾å¿œã§ã™ã€‚
- ãƒ¢ãƒ‡ãƒ«ãŒæä¾›ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³æ•°ãªã©ã®è©³ç´°ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯å–å¾—ã§ããªã„ãŸã‚ `usage` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ã‚¼ãƒ­ã‚’è¿”ã—ã¾ã™ã€‚
- ãƒ¢ãƒ‡ãƒ«å‘¼ã³å‡ºã—ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªãŒå¿…è¦ã§ã™ã€‚åˆå›ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§æ‹’å¦ã•ã‚ŒãŸå ´åˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã«ã¯ 500 ã‚¨ãƒ©ãƒ¼ãŒè¿”ã‚Šã¾ã™ã€‚VS Code ã§ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
- ADK API: ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã¯ãƒ¡ãƒ¢ãƒªå†…ã®ã¿ä¿å­˜ã•ã‚Œã€ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ã§æ¶ˆå¤±ã—ã¾ã™ã€‚
